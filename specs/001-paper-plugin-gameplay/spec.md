# Feature Specification: Candy Rush - チーム対戦型ポイント収集ゲーム

**Feature Branch**: `001-paper-plugin-gameplay`
**Created**: 2025-10-20
**Status**: Draft
**Input**: User description: "minecraftのpaperプラグインをもちいてゲーム性をくわえたマイクラを提供したい"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - ゲーム参加と基本プレイ (Priority: P1)

プレイヤーはサーバーに接続し、3チーム（青、緑、黄）のいずれかに自動振り分けされる。最低人数（デフォルト2人）が揃うと10秒のカウントダウンが開始され、ゲームが始まる。プレイヤーはマップ上に配置された宝箱を探索し、中から食べ物を取得することでポイントを獲得する。ゲームは時間制限で終了し、最もチームポイントが高いチームが勝利する。ゲーム終了後は5分のクールダウンを経て、自動的に次のゲームが開始される。

**Why this priority**: ゲームの最も基本的な流れであり、これがなければゲームとして成立しない。

**Independent Test**: サーバーに接続してチームに振り分けられ、宝箱を見つけて食べ物を取得し、ポイントが加算されることを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーがサーバーに接続する、**When** ログインが完了する、**Then** 3チーム（青、緑、黄）のうち人数が最も少ないチームに自動振り分けされ、チーム拠点にスポーンする
2. **Given** サーバーに最低人数（デフォルト2人）が揃う、**When** 最低人数に達する、**Then** 10秒のカウントダウンが開始され、全プレイヤーに残り秒数が表示される
3. **Given** カウントダウンが進行中である、**When** カウントダウンが0秒になる、**Then** ゲームが開始され、マップ生成と宝箱配置が行われる
4. **Given** プレイヤーがマップ上の宝箱を発見する、**When** 宝箱を開ける、**Then** 中の食べ物が自動消滅し、個人ポイントとチームポイントに同数が加算される
5. **Given** ゲームが進行中である、**When** 制限時間が経過する、**Then** ゲームが終了し、チームポイントが最も高いチームが勝利する
6. **Given** ゲームが終了する、**When** リザルト表示後、**Then** 5分間のクールダウン期間が開始され、残り時間が表示される
7. **Given** クールダウン期間が終了する、**When** 最低人数が揃っている、**Then** 10秒カウントダウンを経て自動的に新しいゲームが開始される
8. **Given** ゲーム進行中にプレイヤーが切断する、**When** 同じゲーム中に再接続する、**Then** 元のチーム、ポイント、装備、Murdererフラグ、位置が全て復元され、ゲームを継続できる

---

### User Story 2 - 宝箱探索とリスク管理 (Priority: P1)

プレイヤーはマップ上の様々な種類の宝箱を探索する。通常の宝箱からは食べ物のみが得られるが、トラップチェストは開けるとダメージを受ける代わりに、高確率で装備やアイテムが入手できる。プレイヤーはリスクとリターンを考えて探索を進める。

**Why this priority**: ゲームの探索要素とリスク管理の面白さを提供する中核的な機能。

**Independent Test**: 通常宝箱とトラップチェストを開け、それぞれ異なる報酬とリスクが存在することを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーが通常の宝箱（チェスト、樽、かまどなど）を発見する、**When** 宝箱を開ける、**Then** 食べ物のみが入っており、取得時に自動消滅してポイントに変換される
2. **Given** プレイヤーがトラップチェストを発見する、**When** トラップチェストを開ける、**Then** 軽傷ダメージまたは毒状態になり、70%の確率で装備・アイテムが入手できる
3. **Given** プレイヤーが宝箱の中身を全て取得する、**When** 最後のアイテムを取る、**Then** 宝箱は消滅し、数分後にそのチャンク内の別の場所に再出現する

---

### User Story 3 - ポイントでショップ利用 (Priority: P1)

プレイヤーは獲得した個人ポイントを使ってショップから装備、食べ物、ポーション、アイテムを購入できる。スロット9番目に固定されたショップアイテムを持った状態で空中クリックするとGUIメニューが開き、買い物ができる。

**Why this priority**: ポイントシステムに意味を持たせ、戦略的なリソース管理を可能にする重要な機能。

**Independent Test**: ポイントを獲得し、ショップGUIを開いてアイテムを購入し、個人ポイントが減少することを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーがゲームに参加する、**When** スポーンする、**Then** スロット9番目にショップアイテムが固定配置される（ドロップ・移動不可）
2. **Given** プレイヤーがショップアイテムを持っている、**When** 空中をクリックする、**Then** ショップGUIメニューが表示される
3. **Given** プレイヤーが十分な個人ポイントを持っている、**When** ショップでアイテムを購入する、**Then** 個人ポイントが減少し、アイテムがインベントリに追加される（チームポイントは減らない）

---

### User Story 4 - イベントNPCと襲撃イベント (Priority: P2)

プレイヤーはマップ上に配置されたイベントNPC（村人の見た目）を発見する。NPCに近づくと「助けて！」とメッセージが表示される。NPCをクリックすると襲撃イベントが開始され、5分間モンスターが無限に湧き続ける。イベント成功時には感謝のメッセージ、失敗時には罵倒メッセージが表示される。倒した数に応じてポイントを獲得する。

**Why this priority**: 協力プレイと高得点獲得の機会を提供する重要な要素だが、基本的な探索ゲームは成立する。

**Independent Test**: イベントNPCに近づいてメッセージを確認し、クリックして襲撃イベントを開始し、モンスターを倒してポイントを獲得できることを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーがイベントNPCに近づく、**When** NPCの近くに入る、**Then** 「助けて！」といったヘルプメッセージが近くの全プレイヤーに表示される
2. **Given** プレイヤーがイベントNPCを発見する、**When** NPCをクリックする、**Then** 5分間の襲撃イベントが開始され、NPC近くの全プレイヤーが参加者になる
3. **Given** 襲撃イベントが進行中である、**When** プレイヤーがモンスターを倒す、**Then** 倒した数に応じて個人ポイントとチームポイントが加算される
4. **Given** 襲撃イベントが成功する、**When** 5分間経過してイベントが終了する、**Then** 感謝のメッセージが参加者全員に表示される
5. **Given** 襲撃イベント参加中である、**When** プレイヤーがNPCから2チャンク以上離れる、**Then** 逃亡扱いでイベント失敗となり、罵倒メッセージが表示される
6. **Given** 襲撃イベントが進行中である、**When** プレイヤーがモンスターにダメージを与える、**Then** そのプレイヤーはイベント参加者として記録される
7. **Given** イベントNPCが存在する、**When** プレイヤーやモンスターが攻撃する、**Then** NPCはダメージを受けない（無敵）

---

### User Story 5 - ボス戦 (Priority: P2)

ゲーム全体でイベントNPCが設定回数クリアされると、最後のイベントNPC位置にボスが出現する。全プレイヤーにボスバーが表示され、ボス戦が始まる。ボスは複数人で協力しないと倒せない強敵で、倒すとレアアイテムをドロップし、戦闘参加者全員にポイントが付与される。

**Why this priority**: ゲームのハイライトとなる要素だが、基本的なゲームプレイは他の要素で成立する。

**Independent Test**: イベントを規定回数クリアしてボスを出現させ、ボスバーが表示され、倒すとポイントと報酬が得られることを確認できる。

**Acceptance Scenarios**:

1. **Given** ゲーム全体でイベントNPCが設定回数クリアされる、**When** 最後のイベントがクリアされる、**Then** その位置にボスが出現し、全プレイヤーにボスバーが表示される
2. **Given** ボスが出現している、**When** 他のイベントNPCをクリアする、**Then** クリア回数としてカウントされない（ボスは1体のみ存在）
3. **Given** プレイヤーがボス戦に参加する、**When** ボスを倒す、**Then** レアアイテムがドロップ（早い者勝ち）され、戦闘参加者全員に個人・チームポイントが付与される（死亡していても獲得可能）
4. **Given** ボスが出現している、**When** ボス戦が進行する、**Then** 全プレイヤーにボスのHP状況がボスバーで表示される

---

### User Story 6 - PvPとMurdererシステム (Priority: P3)

プレイヤーはMurderer状態の相手以外を攻撃すると、自動的にMurdererフラグが立ち、厳しいペナルティを受ける。Murdererになると一時的にREDチーム（赤）に移動し、元のチームから完全に除外される。このシステムにより、PvPは可能だが強力な抑止力が働く。Murdererは攻撃するたびに3分ずつペナルティ時間が累積し、最大60分間ペナルティを受ける。

**Why this priority**: PvPバランスを保つ重要な要素だが、ゲームの中核ではない。

**Independent Test**: Murdererでないプレイヤーを攻撃してMurdererフラグが立ち、REDチームに移動してペナルティが適用されることを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーがMurdererでないプレイヤーを攻撃する（PK行為）、**When** 攻撃が成功する、**Then** Murdererフラグが立ち、プレイヤー名が赤字表示になり、一時的にREDチーム（赤）に移動し、3分間のペナルティが課される
2. **Given** プレイヤーがMurderer状態になる、**When** REDチームに移動する、**Then** 元のチーム（青、緑、黄）のプレイヤーからペナルティなしで攻撃され、元のチームメイトも攻撃できる
3. **Given** プレイヤーがMurderer状態のプレイヤーを攻撃する、**When** 攻撃が成功する、**Then** Murdererフラグは立たず、通常のPvPとして処理される（ペナルティなし）
4. **Given** プレイヤーがMurdererフラグを持っている、**When** フラグが有効である、**Then** 防具を装備できなくなり、他プレイヤーからペナルティなしで攻撃され、死亡時に装備をドロップする
5. **Given** Murderer状態のプレイヤーが再度PK行為を行う、**When** 攻撃が成功する、**Then** ペナルティ時間が3分ずつ累積され、最大60分まで延長される
6. **Given** Murdererフラグが立っている、**When** 死亡するかペナルティ時間が経過する、**Then** Murdererフラグが解除され、元のチーム（青、緑、黄）に戻る
7. **Given** プレイヤーがMurderer状態である、**When** ポイントを獲得する、**Then** 個人ポイントと元のチームポイントに加算される（REDチームではなく元のチームに貢献）

---

### User Story 7 - 死亡とリスポーン (Priority: P2)

プレイヤーが死亡した場合、チーム拠点または設置したベッドの位置にリスポーンする。通常は装備を保持したままリスポーンできるが、Murdererフラグが立っている場合は装備をドロップする。ポイントは失われない。

**Why this priority**: ゲーム進行の重要な要素だが、他の機能が確立された後に調整可能。

**Independent Test**: 死亡してリスポーンし、装備とポイントの状態を確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーが死亡する、**When** 通常状態で死亡する、**Then** ベッド位置（なければチーム拠点）にリスポーンし、装備を保持し、ポイントは減らない
2. **Given** プレイヤーがMurderer状態で死亡する、**When** 死亡する、**Then** 装備をドロップし、ベッド位置にリスポーンし、Murdererフラグが解除される
3. **Given** プレイヤーがベッドを設置する、**When** ベッドで寝る、**Then** リスポーン地点がそのベッドの位置に設定される

---

### User Story 8 - ゲーム終了とリザルト (Priority: P1)

制限時間が経過するとゲームが終了し、リザルト画面が表示される。チームポイントで勝敗が決まり、各チーム内のMVP（個人ポイント最高者）が表示される。ゲーム終了時、全てのゲーム関連エンティティ（宝箱、NPC、ボス、モンスター、ドロップアイテム）が削除され、プレイヤーの状態がリセットされる。その後、自動的に新しいゲームが開始される。

**Why this priority**: ゲームの終了処理と次回ゲームへの移行は、ゲーム体験の完結に必須。適切な後始末がないと次のゲームに影響が出る。

**Independent Test**: 制限時間経過後、リザルトが表示され、全てのゲーム要素がクリーンアップされ、自動的に新しいゲームが開始されることを確認できる。

**Acceptance Scenarios**:

1. **Given** ゲームが進行中である、**When** 制限時間が経過する、**Then** ゲームが終了し、チームポイント最高のチームが勝利として表示される
2. **Given** ゲームが終了する、**When** リザルト画面が表示される、**Then** 各チームのポイントと各チーム内のMVP（個人ポイント最高者）が表示される
3. **Given** ゲームが終了する、**When** 終了処理が実行される、**Then** 全ての宝箱、イベントNPC、ボス、モンスター、ドロップアイテムが削除される
4. **Given** ゲームが終了する、**When** 終了処理が実行される、**Then** 全プレイヤーのポイント、ステータス効果、Murdererフラグがクリアされる
5. **Given** リザルト表示が完了する、**When** 一定時間経過する、**Then** 新しいゲームが自動的に開始される

---

### User Story 10 - ゲーム初期化と後始末 (Priority: P1)

ゲーム開始時、前回ゲームの残骸（宝箱、NPC、ボス、モンスター、ドロップアイテム）が完全に削除され、全プレイヤーが完全ノーマル状態にリセットされる。プレイヤーは安全に自チームの拠点にテレポートされる。ゲーム終了時にも同様の後始末が行われ、次回開始時にダブルチェックされる。

**Why this priority**: ゲームの初期化と後始末は、公平で安定したゲーム環境を保証するために必須。残骸があると次のゲームに悪影響を与える。

**Independent Test**: ゲーム開始時に前回の残骸が全て削除され、プレイヤーが適切にリセットされて拠点にテレポートされることを確認できる。

**Acceptance Scenarios**:

1. **Given** 新しいゲームが開始する、**When** 初期化処理が実行される、**Then** 前回ゲームの全ての宝箱、イベントNPC、ボス、モンスター、ドロップアイテムが削除される（ダブルチェック）
2. **Given** 新しいゲームが開始する、**When** 初期化処理が実行される、**Then** 全プレイヤーのインベントリがクリアされ、ポイントが0になり、HP・満腹度が満タンになり、全てのステータス効果（バフ・デバフ）とMurdererフラグがクリアされる
3. **Given** 新しいゲームが開始する、**When** プレイヤーのテレポート処理が実行される、**Then** 全プレイヤーが安全に（サーバー負荷を考慮して）自チームの拠点にテレポートされる
4. **Given** ゲームが終了する、**When** 後始末処理が実行される、**Then** 全てのゲーム関連エンティティが削除される
5. **Given** 設定で中心構造物が固定されている、**When** 新しいゲームが開始する、**Then** 管理者が指定した構造物を中心にマップが設定される
6. **Given** 設定で中心構造物が固定されていない、**When** 新しいゲームが開始する、**Then** 自動で地上の構造物をランダムに選択してマップの中心とする
7. **Given** プレイヤーが設置したブロックやベッドが存在する、**When** ゲーム初期化が実行される、**Then** それらはそのまま残る（ワールドの再生成は管理者に任せる）

---

### User Story 9 - ゲーム情報表示システム (Priority: P1)

プレイヤーは常に画面右側のスコアボードで自分のチーム、個人ポイント、チームスコア、残り時間を確認できる。重要なゲームイベント（ボス出現、Murderer発生、順位変動など）はタイトルメッセージで通知される。イベント中やボス戦中はアクションバーで進行状況を確認できる。

**Why this priority**: ゲーム情報の可視化はプレイヤー体験の中核であり、ゲーム進行に必須。

**Independent Test**: スコアボードが常に表示され、各種イベント時にタイトルメッセージやアクションバーが適切に更新されることを確認できる。

**Acceptance Scenarios**:

1. **Given** プレイヤーがゲーム中である、**When** 画面を確認する、**Then** 画面右側に所属チーム、個人ポイント、チームスコア、残り時間が表示される
2. **Given** プレイヤーがチームに振り分けられる、**When** ゲーム開始時またはサーバー参加時、**Then** タイトルメッセージとチャットで「〇〇チームに参加しました」と表示される
3. **Given** ボスが出現する、**When** ボス出現条件を満たす、**Then** 全プレイヤーにタイトルメッセージで「ボス出現！」と通知される
4. **Given** プレイヤーがMurdererになる、**When** 他チームにダメージを与える、**Then** 全プレイヤーにタイトルメッセージで「[プレイヤー名]がMurdererになった！」と表示される
5. **Given** 自チームが1位になる、**When** チームスコアが他チームを上回る、**Then** 自チームメンバーにタイトルメッセージで「1位になった！」と表示される
6. **Given** 襲撃イベント中である、**When** イベント進行中、**Then** アクションバーに残り時間が表示される
7. **Given** ボス戦中である、**When** ボスと戦闘中、**Then** アクションバーにボスのHP（ライフ）が表示される
8. **Given** プレイヤーが `/stats` コマンドを実行する、**When** コマンドを入力する、**Then** 全3チーム（青、緑、黄）のスコアと個人ポイントランキング上位5名がチャットに表示される
9. **Given** ゲームが終了する、**When** 制限時間が経過する、**Then** 「ゲームセット！」メッセージがチャットに表示され、優勝チームがタイトルメッセージで通知される
10. **Given** ゲーム終了時である、**When** リザルトが表示される、**Then** チャットに各チームのスコアと各チーム内MVPが表示される
11. **Given** プレイヤーがタブリスト（TABキー）を開く、**When** タブキーを押す、**Then** プレイヤー名がチームカラーで色分けして表示される

---

### Edge Cases

- **途中参加プレイヤー**: ゲーム進行中に参加したプレイヤーは、ポイント0、装備なしでスタートするが、既に進行中のチームに振り分けられるため不利になる可能性がある
- **宝箱の同時アクセス**: 複数プレイヤーが同時に同じ宝箱を開けた場合、アイテムの取得順序やポイント付与はどのように処理されるか？
- **イベント中のプレイヤー切断**: 襲撃イベント中にプレイヤーが切断した場合、参加者としてカウントされ続けるか？それとも除外されるか？
- **ボス戦中のゲーム終了**: ボス戦の途中で制限時間が来た場合、ボスはどうなるか？ボス戦を優先して延長するか？
- **Murdererフラグ中のイベント参加**: Murderer状態でイベントやボス戦に参加した場合、防具なしで戦うことになるが、これは意図した挙動か？
- **ベッド破壊**: 他プレイヤーやMobによってベッドが破壊された場合、リスポーン地点はどうなるか？
- **宝箱の再出現位置**: 同じチャンク内に複数の宝箱が集中する可能性があるか？それとも一定の間隔を保つか？
- **ショップアイテムの削除試み**: プレイヤーがショップアイテムを削除しようと様々な方法を試した場合（投げる、クラフトに使う、かまどに入れるなど）、全て防げるか？
- **テレポート中のプレイヤー切断**: ゲーム開始時のテレポート処理中にプレイヤーが切断した場合、どのように処理されるか？
- **初期化処理の失敗**: ゲーム初期化中にエラーが発生した場合、ゲームは開始されるか？それとも中断されるか？
- **構造物が見つからない**: ランダム選択時に地上の構造物が見つからない場合、どのように処理されるか？
- **ゲーム終了後の再接続**: プレイヤーがゲーム終了後（次のゲーム開始前）に再接続した場合、どのように処理されるか？
- **イベント参加中のログアウト**: プレイヤーが襲撃イベントやボス戦に参加中にログアウトし、イベント終了後に再接続した場合、報酬は獲得できるか？
- **データ永続化の頻度**: プレイヤーの状態はどのタイミングで保存されるか？（リアルタイム、定期的、ログアウト時のみなど）
- **カウントダウン中のプレイヤー離脱**: 10秒カウントダウン中にプレイヤーが切断し、最低人数を下回った場合、カウントダウンはキャンセルされるか？
- **クールダウン中のプレイヤー参加**: クールダウン期間中に新しいプレイヤーが参加した場合、どのように処理されるか？待機状態になるか？
- **カウントダウン中の新規参加**: カウントダウン中に新しいプレイヤーが参加した場合、カウントダウンは継続するか？リセットされるか？
- **最低人数ちょうどでゲーム開始**: 最低人数ちょうどでゲームが開始された場合、1人でも切断するとゲームは続行されるか？強制終了されるか？

## Requirements *(mandatory)*

### Functional Requirements

**ゲーム基本システム**

- **FR-001**: システムはプレイヤーがサーバーに接続した際、3チーム（青、緑、黄）のうち人数が最も少ないチームに自動振り分けしなければならない（REDチームはMurderer専用のため通常割り当ては行わない）
- **FR-001-1**: ゲーム進行中にプレイヤーが再接続した際、システムは元のチーム、個人ポイント、チームポイント貢献度、装備、Murdererフラグ、ログアウト時の座標位置を全て保持し復元しなければならない
- **FR-001-2**: ゲーム進行中にプレイヤーが再接続した際、システムはプレイヤーをログアウト時の座標位置にテレポートしなければならない
- **FR-002**: システムはゲーム開始時、ランダムに選択された地上の構造物を中心座標とし、直径500ブロック（半径250ブロック）のマップを生成しなければならない
- **FR-003**: システムはマップの3箇所をそれぞれのチーム拠点とし、チームカラー（青、緑、黄）のコンクリートブロックを足元に配置しなければならない
- **FR-004**: システムはマップの境界にバリアブロックを配置し、プレイヤーが外に出られないようにしなければならない
- **FR-005**: システムはゲームを時間制限で管理し、設定で変更可能な制限時間経過後にゲームを終了しなければならない
- **FR-006**: システムはサーバーに最低人数（デフォルト2人、設定で変更可能）のプレイヤーが揃った際、10秒のカウントダウンを開始しなければならない
- **FR-006-1**: カウントダウン中、全プレイヤーにタイトルメッセージまたはアクションバーで残り秒数を表示しなければならない
- **FR-006-2**: カウントダウンが0秒になった際、ゲームを開始しなければならない
- **FR-006-3**: カウントダウン中にプレイヤー数が最低人数を下回った場合、カウントダウンをキャンセルしなければならない
- **FR-007**: システムはゲーム終了後、5分間のクールダウン期間を設けなければならない
- **FR-007-1**: クールダウン期間中、プレイヤーにクールダウン終了までの残り時間を表示しなければならない
- **FR-007-2**: クールダウン期間終了後、サーバーに最低人数のプレイヤーがいる場合、自動的に10秒カウントダウンを開始して新しいゲームを開始しなければならない
- **FR-007-3**: クールダウン期間終了時にプレイヤー数が最低人数未満の場合、最低人数が揃うまで待機しなければならない

**ポイントシステム**

- **FR-008**: システムは個人ポイントとチームポイントの2種類のポイントを管理しなければならない
- **FR-009**: システムはプレイヤーがポイントを獲得した際、個人ポイントとチームポイントに同数を加算しなければならない
- **FR-010**: 個人ポイントはショップでの購入に使用され、使用すると減少しなければならない
- **FR-011**: チームポイントは勝敗判定にのみ使用され、消費されずに累積しなければならない
- **FR-012**: システムは各プレイヤーのポイント内訳を記録し、ゲーム終了時にMVP判定に使用しなければならない

**宝箱システム**

- **FR-013**: システムは1チャンクに1個の割合で宝箱を地上にランダム配置しなければならない
- **FR-014**: 宝箱の種類は、チェスト、ラージチェスト、樽、かまど、溶鉱炉、燻製器、醸造台、ホッパー、ドロッパー、ディスペンサー、トラップチェストを含まなければならない
- **FR-015**: トラップチェスト以外の宝箱には食べ物のみが入っており、取得時に自動消滅して個人・チームポイントに変換されなければならない
- **FR-016**: トラップチェストは開けると軽傷ダメージまたは毒状態を付与し、70%の確率で装備・アイテム（武器、防具、道具、エンダーパール、金リンゴ、ポーションなど）を提供しなければならない
- **FR-017**: 装備・アイテムは自動消滅せず、通常通りプレイヤーのインベントリに追加されなければならない
- **FR-018**: 宝箱の中身が全て取得されたら、宝箱は消滅し、ランダムな時間経過後に同じチャンク内の別の場所に再出現しなければならない

**ショップシステム**

- **FR-019**: システムはゲーム開始時、全プレイヤーのスロット9番目にショップアイテムを固定配置しなければならない
- **FR-020**: ショップアイテムはドロップ不可、移動不可でなければならない
- **FR-021**: プレイヤーがショップアイテムを持った状態で空中クリックした際、ショップGUIメニューを表示しなければならない
- **FR-022**: ショップでは基本的な装備、食べ物、ポーション、アイテムを個人ポイントで購入できなければならない
- **FR-023**: ショップでアイテムを購入した際、個人ポイントのみが減少し、チームポイントは減少してはならない

**イベントNPCシステム**

- **FR-024**: システムは3チャンクに1体の割合でイベントNPC（村人の見た目、MythicMobsで実装）を配置しなければならない
- **FR-024-1**: イベントNPCは無敵でなければならない（プレイヤーやモンスターからダメージを受けない）
- **FR-024-2**: プレイヤーがイベントNPCに近づいた際、「助けて！」といったヘルプメッセージをNPC近くの全プレイヤーに表示しなければならない
- **FR-025**: プレイヤーがイベントNPCをクリックした際、5分間の襲撃イベントを開始しなければならない
- **FR-026**: 襲撃イベント開始時、NPC近くの全プレイヤーを参加者として登録しなければならない
- **FR-027**: 襲撃イベント中、モンスターにダメージを与えたプレイヤーを参加者として追加しなければならない
- **FR-028**: 襲撃イベント中、MythicMobsで定義されたモンスターが5分間無限に湧き続けなければならない
- **FR-029**: プレイヤーが倒したモンスターの数に応じて個人・チームポイントを付与しなければならない
- **FR-029-1**: MythicMobsで定義されたモンスターがドロップアイテムを持つ場合、そのアイテムも取得可能でなければならない
- **FR-030**: 襲撃イベント中、プレイヤーがNPCから2チャンク以上離れた場合、逃亡扱いでイベント失敗とし、罵倒メッセージを表示しなければならない
- **FR-031**: 襲撃イベント成功時、感謝のメッセージを参加者全員に表示しなければならない
- **FR-032**: ゲーム全体でイベントNPCが設定回数（デフォルト3回、設定で変更可能）クリアされた際、ボスを出現させなければならない

**ボスシステム**

- **FR-033**: ボスはMythicMobsで定義された強力なモンスターとして、最後にクリアされたイベントNPCの位置に出現しなければならない
- **FR-034**: ボス出現時、全プレイヤーにボスバーを表示し、ボスのHP状況を可視化しなければならない
- **FR-035**: ゲーム上にボスは1体のみ存在し、ボス出現中のイベントNPCクリアはカウントされてはならない
- **FR-036**: ボスは複数人で協力しないと倒せない強力なモンスターでなければならない
- **FR-037**: ボスを倒した際、MythicMobsで設定されたレアアイテムをドロップし、戦闘参加者全員に個人・チームポイントを付与しなければならない（死亡していても獲得可能）
- **FR-038**: MythicMobsで設定されたドロップアイテムは早い者勝ちで取得できなければならない

**PvPとMurdererシステム**

- **FR-038-1**: システムは同じチーム同士のプレイヤー間の攻撃を無効化しなければならない（チーム保護）
- **FR-038-2**: Murderer状態のプレイヤーはチーム保護から除外され、元のチームメイトと相互に攻撃可能にならなければならない
- **FR-039**: システムはMurderer状態のプレイヤーを攻撃した場合、攻撃者にペナルティを課してはならない（正当防衛）
- **FR-040**: プレイヤーがMurdererでないプレイヤーにダメージを与えた際（PK行為）、攻撃者にMurdererフラグを立て、一時的にREDチーム（赤）に移動させ、3分間のペナルティを課さなければならない
- **FR-040-1**: Murderer状態のプレイヤーが再度PK行為を行った際、ペナルティ時間を3分ずつ累積し、最大60分まで延長しなければならない
- **FR-041**: Murdererフラグが立ったプレイヤーは防具を装備できなくなり、他プレイヤーからペナルティなしで攻撃され、死亡時に装備をドロップしなければならない
- **FR-042**: Murdererフラグが立ったプレイヤーの名前を赤字表示しなければならない
- **FR-043**: Murdererフラグは死亡またはペナルティ時間経過（3分〜最大60分）で自動解除され、プレイヤーは元のチーム（青、緑、黄）に戻らなければならない
- **FR-043-1**: Murderer状態のプレイヤーが獲得したポイントは、REDチームではなく元のチーム（青、緑、黄）に加算されなければならない

**プレイヤー表示システム**

- **FR-044**: システムは全プレイヤーの名前をプレイヤーの頭上に常に表示しなければならない
- **FR-045**: 通常プレイヤーの名前は白色、Murdererプレイヤーの名前は赤色で表示しなければならない

**死亡とリスポーン**

- **FR-046**: プレイヤーが死亡した際、設置したベッドの位置（なければチーム拠点）にリスポーンしなければならない
- **FR-047**: 通常死亡時、プレイヤーは装備を保持したままリスポーンしなければならない
- **FR-048**: Murderer状態での死亡時、プレイヤーは装備をドロップしなければならない
- **FR-049**: 死亡時、プレイヤーのポイント（個人・チーム）は減少してはならない
- **FR-050**: プレイヤーは自由にベッドを設置でき、設置したベッドをリスポーン地点として使用できなければならない

**ゲーム終了とリザルト**

- **FR-051**: 制限時間経過時、ゲームを終了し、チームポイントが最も高いチームを勝利チームとして判定しなければならない
- **FR-052**: リザルト画面では、各チームのポイントと各チーム内のMVP（個人ポイント最高者）を表示しなければならない
- **FR-053**: クールダウン期間終了後、最低人数が揃っている場合は10秒カウントダウンを経て自動的に新しいゲームを開始しなければならない

**ゲーム初期化と後始末**

- **FR-054**: ゲーム終了時、全ての宝箱（11種類全て）、イベントNPC、ボス、襲撃イベントのモンスター、ドロップアイテムを削除しなければならない
- **FR-055**: ゲーム開始時、前回ゲームの残骸（宝箱、イベントNPC、ボス、モンスター、ドロップアイテム）が残っていないかダブルチェックし、残っていれば削除しなければならない
- **FR-056**: ゲーム開始時、全プレイヤーのインベントリをクリアしなければならない
- **FR-057**: ゲーム開始時、全プレイヤーのポイント（個人・チーム）を0にリセットしなければならない
- **FR-058**: ゲーム開始時、全プレイヤーのHP（体力）と満腹度を最大値に設定しなければならない
- **FR-059**: ゲーム開始時、全プレイヤーの全てのステータス効果（バフ・デバフ）をクリアしなければならない
- **FR-060**: ゲーム開始時、全プレイヤーのMurdererフラグをクリアしなければならない
- **FR-061**: ゲーム開始時、全プレイヤーを自チームの拠点に安全にテレポートしなければならない（一度に全プレイヤーを処理するとサーバー負荷が高くタイムアウトの危険があるため、適切な方法で処理）
- **FR-062**: 設定で中心構造物が固定されている場合、管理者が指定した構造物を中心座標としてマップを設定しなければならない
- **FR-063**: 設定で中心構造物が固定されていない場合、自動で地上の構造物をランダムに選択してマップの中心座標としなければならない
- **FR-064**: ゲーム初期化処理は、プレイヤーが設置したブロックやベッドには影響を与えてはならない（ワールドの再生成は管理者の責任）
- **FR-065**: 同じワールドを使い続け、ワールドの再生成は管理者に任せなければならない

**初期設定**

- **FR-066**: ゲーム開始時、プレイヤーは装備なし、ポイント0でスタートしなければならない

**天候と時間の管理**

- **FR-067**: システムはゲーム中の天候を常に晴れ（Clear）に保たなければならない
- **FR-068**: 天候設定は設定ファイルで変更可能でなければならない
- **FR-069**: システムはゲーム中の時間を自然に進行させなければならない
- **FR-070**: 時間が夜になった際、システムは自動的に時間を朝（Day）にリセットしなければならない

**ゲーム情報表示システム**

- **FR-071**: システムは画面右側のスコアボードに、所属チーム、個人ポイント、チームスコア、残り時間を常に表示しなければならない
- **FR-072**: スコアボードの表示形式は以下の通りでなければならない：タイトル行、空行、チーム名、個人ポイント、チームスコア、空行、残り時間
- **FR-073**: プレイヤーがチームに振り分けられた際、タイトルメッセージとチャットメッセージの両方で「〇〇チームに参加しました」と通知しなければならない
- **FR-074**: ゲーム開始カウントダウン中、全プレイヤーにタイトルメッセージまたはアクションバーで残り秒数を表示しなければならない
- **FR-075**: ボス出現時、全プレイヤーにタイトルメッセージで「ボス出現！」と通知しなければならない
- **FR-076**: プレイヤーがMurdererになった際、全プレイヤーにタイトルメッセージで「[プレイヤー名]がPK行為を行い、Murdererになった！」と通知しなければならない
- **FR-077**: 自チームが1位になった際、自チームメンバーのみにタイトルメッセージで「1位になった！」と通知しなければならない
- **FR-078**: イベントNPCの襲撃イベント参加時、参加者本人にタイトルメッセージで「襲撃イベント参加！」と通知しなければならない
- **FR-079**: 襲撃イベント中、参加者のアクションバーに残り時間を表示しなければならない
- **FR-080**: ボス戦中、全プレイヤーのアクションバーにボスのHP（ライフ）を表示しなければならない
- **FR-081**: クールダウン期間中、プレイヤーにクールダウン終了までの残り時間を表示しなければならない
- **FR-082**: プレイヤーが `/stats` コマンドを実行した際、チャットに全3チーム（青、緑、黄）のスコアと個人ポイントランキング上位5名を表示しなければならない
- **FR-083**: ゲーム終了時、チャットに「ゲームセット！」メッセージを表示しなければならない
- **FR-084**: ゲーム終了時、タイトルメッセージで優勝チームを通知しなければならない（例：「黄色チームの優勝！」）
- **FR-085**: ゲーム終了時、チャットに各チームのスコアと各チーム内MVPをリザルトとして表示しなければならない
- **FR-086**: タブリスト（TABキー）では、プレイヤー名をチームカラー（青、緑、黄、赤）で色分けして表示しなければならない（Murderer状態のプレイヤーは赤で表示）
- **FR-087**: 襲撃イベント終了時、全プレイヤーにタイトルメッセージでイベント結果（成功/失敗）を通知しなければならない

### Key Entities

- **プレイヤー**: ゲームに参加する個人。所属チーム、個人ポイント、チームポイント貢献度、装備、Murdererフラグ状態、リスポーン地点を持つ
- **チーム**: ゲームチーム3つ（青、緑、黄）+ Murderer専用チーム1つ（赤）。チームカラー、チームポイント、所属プレイヤーリスト、拠点位置を持つ。REDチームは通常の割り当てには使用されず、Murderer状態のプレイヤーのみが一時的に所属する
- **宝箱**: マップ上に配置されるアイテム入手源。種類（11種類）、位置、中身、再出現タイマーを持つ
- **食べ物**: 宝箱から取得できる消費アイテム。種類、ポイント価値を持ち、取得時に自動消滅してポイントに変換される
- **装備・アイテム**: トラップチェストやショップから入手できる。種類（武器、防具、道具、消費アイテム）、エンチャントの有無を持つ
- **イベントNPC**: 襲撃イベントを発動するNPC（村人の見た目、MythicMobsで実装、無敵）。位置、クリア済みフラグ、参加者リスト、表示メッセージ（ヘルプ、感謝、罵倒）を持つ
- **襲撃イベント**: 5分間のモンスター討伐イベント。開始時刻、参加者リスト、討伐数、終了条件、出現するMythicMobsモンスターの種類を持つ
- **ボス**: ゲーム全体で1体のみ存在する強力なモンスター（MythicMobsで定義）。HP、位置、戦闘参加者リスト、MythicMobsで設定されたドロップアイテムを持つ
- **MythicMobsモンスター**: 襲撃イベントやボス戦で出現するカスタムモンスター。種類、HP、攻撃力、ドロップアイテム、特殊能力を持つ
- **ゲームラウンド**: 1回のゲームセッション。開始時刻、終了時刻、制限時間、中心構造物、マップ範囲、イベントクリア回数を持つ
- **ショップ**: アイテム購入システム。販売アイテムリスト、価格（個人ポイント）を持つ
- **スコアボード**: 画面右側に表示されるゲーム情報パネル。所属チーム、個人ポイント、チームスコア、残り時間を表示
- **タイトルメッセージ**: 画面中央に大きく表示される通知。ボス出現、Murderer発生、順位変動、ゲーム終了などの重要イベントを通知
- **アクションバー**: インベントリ上に表示される一時的な情報。襲撃イベントの残り時間、ボスのHPを表示
- **タブリスト**: TABキーで表示されるプレイヤーリスト。プレイヤー名をチームカラーで色分けして表示
- **コマンド**: プレイヤーが実行できる操作。`/stats`コマンドで全チームスコアと個人ランキングを確認可能

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: プレイヤーはサーバー接続からゲーム開始まで30秒以内に参加できる
- **SC-002**: システムは同時接続50人以上のプレイヤーをサポートし、パフォーマンス低下なくゲーム進行できる
- **SC-003**: 宝箱からのアイテム取得からポイント反映まで1秒以内に完了する
- **SC-004**: プレイヤーの90%以上が初回プレイ時に、10分以内に基本的なゲームルール（宝箱探索、ポイント獲得、ショップ利用）を理解できる
- **SC-005**: 襲撃イベント開始から終了まで、エラーによる中断が1%未満である
- **SC-006**: ボス戦に参加したプレイヤーの80%以上が「協力プレイが楽しかった」と評価する
- **SC-007**: ゲームラウンドの開始から終了、次ラウンド開始まで、エラーやバグによる中断が1%未満である
- **SC-008**: プレイヤーの85%以上が「宝箱探索とリスク管理が面白い」と評価する
- **SC-009**: Murdererシステムにより、PvP発生率がゲーム全体の5%未満に抑えられる
- **SC-010**: プレイヤーの進捗データ（ポイント、装備など）は99.9%の確率でサーバークラッシュ後も復元可能である
- **SC-011**: スコアボードの情報更新は1秒以内に反映される
- **SC-012**: タイトルメッセージは重要イベント発生から0.5秒以内に全プレイヤーに表示される
- **SC-013**: プレイヤーの90%以上が「ゲーム情報が分かりやすく表示されている」と評価する

## Dependencies *(mandatory)*

### External Dependencies

- **Minecraft Java Edition**: 対応バージョン範囲を定義する必要あり
- **Paperサーバーソフトウェア**: 最小バージョン要件を定義する必要あり
- **MythicMobs**: カスタムモンスター（襲撃イベント、ボス）およびイベントNPCの実装に使用
- プレイヤーデータ永続化のためのストレージシステム

### Assumptions

- プレイヤーは正規版のMinecraft Javaエディションを所有している
- サーバーは安定したインターネット接続と十分なハードウェアリソース（CPU、メモリ、ストレージ）を持つ
- プレイヤーは基本的なMinecraftの操作方法（移動、ブロック破壊、インベントリ管理など）を理解している
- サーバー管理者は基本的なサーバー管理スキル（プラグイン導入、設定ファイル編集など）を持つ
- ゲームコンテンツは日本語を主要言語とするが、将来的には多言語対応も検討可能
- プレイヤー間のコミュニケーションは主にゲーム内チャットを使用する
- マップ生成に使用する構造物は、ワールド生成時に十分な数が存在することを前提とする（ランダム選択の場合）
- ゲームチーム3つ（青、緑、黄）+ Murderer専用チーム（赤）1つの構成のため、最低3人以上のプレイヤーを想定（理想的には6人以上）
- ゲームの最低開始人数はデフォルト2人だが、設定で変更可能
- ゲーム開始前の10秒カウントダウン中にプレイヤーが最低人数を下回った場合、カウントダウンはキャンセルされる
- ゲーム終了後は5分間のクールダウン期間があり、その後最低人数が揃っていれば自動的に次のゲームが開始される
- 同じワールドを使い続けるため、プレイヤーが設置/破壊したブロックはゲーム間で持ち越される（ワールドの再生成は管理者の責任）
- テレポート処理は適切な方法で実装され、サーバー負荷を考慮して安全に実行される
- ゲーム進行中のプレイヤー状態（チーム、ポイント、装備、Murdererフラグ、位置）はリアルタイムで保存され、再接続時に復元可能
- 天候は晴れに固定され、時間は自然進行するが夜になると自動的に朝にリセットされる（設定で変更可能）
- MythicMobsのモンスターは`PreventSunburn`設定により日光ダメージを受けない

## Out of Scope *(mandatory)*

以下の要素は現在のバージョンでは対象外とする：

- Minecraft Bedrockエディションのサポート
- モバイルデバイス向けの専用UI
- ボイスチャット機能
- 外部Webサイトやアプリとの統合（リーダーボードWebサイトなど）
- リアルマネー課金システムやマイクロトランザクション
- クロスサーバー対戦（複数のMinecraftサーバー間でのプレイヤー連携）
- AIボット（NPC）のチームメンバー
- 動画録画や配信機能の組み込み
- カスタムスキンやテクスチャパックの自動配布
- チーム数の可変設定（ゲームチーム3つ + Murderer専用チーム1つで固定）
- ランク制度やシーズンシステム
- プレイヤー間のアイテムトレード機能
- カスタムマップエディター
- 観戦モード

## Risks & Mitigation *(optional)*

### リスク要因

1. **パフォーマンス問題**: 多数のプレイヤー、宝箱、イベント、ボスが同時に存在することでサーバーパフォーマンスが低下する可能性
   - **軽減策**: 負荷テストを実施し、パフォーマンスボトルネックを事前に特定。宝箱の同時出現数制限、イベントの同時実行数制限などの最適化戦略を計画段階で検討

2. **ゲームバランスの調整難**: トラップチェストの報酬確率、ショップ価格、ボスの強さ、Murdererペナルティなど、多数のバランス調整要素が存在
   - **軽減策**: 柔軟な設定変更を可能にし、プレイテストを重ねてバランスを調整。データ収集機能を組み込み、プレイヤー行動を分析

3. **プレイヤー体験の複雑さ**: ルールが多岐にわたるため、新規プレイヤーが理解するのに時間がかかる可能性
   - **軽減策**: ゲーム内チュートリアルやヘルプコマンドを実装。ルール説明書やWikiの整備を検討

4. **MythicMobsとCitizensへの依存**: 外部プラグインの更新停止やバグにより、ゲーム機能に影響が出る可能性
   - **軽減策**: 依存プラグインのバージョンを固定し、安定版を使用。可能であれば代替手段も検討

5. **データ損失**: サーバー障害時にプレイヤーのポイントや装備が失われるリスク
   - **軽減策**: 定期的な自動バックアップと、重要なイベント（ポイント獲得、装備入手）発生時の即座のデータ保存を実装

6. **不正行為**: チート行為やバグ悪用によりゲームバランスが崩れる可能性（無限ポイント獲得、アイテム複製など）
   - **軽減策**: 基本的な不正行為検出機能（異常なポイント増加、不可能な移動など）を計画に含める。ログ記録とモニタリング機能を実装

7. **途中参加の不公平感**: ゲーム進行中に参加したプレイヤーは、既にポイントを獲得している他プレイヤーと比べて不利
   - **軽減策**: 途中参加者に初期ポイントを付与する、または参加時間に応じたハンディキャップシステムを検討（将来的な改善点）

8. **テレポート処理のサーバー負荷**: ゲーム開始時に全プレイヤーを一度にテレポートするとサーバー負荷が高く、タイムアウトやサーバークラッシュの危険がある
   - **軽減策**: テレポート処理を適切に分散（例：数人ずつ処理、適切な遅延処理など）。全てを非同期で処理するとサーバーが落ちる事例があるため、慎重に実装

9. **ゲーム初期化の不完全性**: 前回ゲームの残骸（宝箱、NPC、ボス、アイテムなど）が残っていると、次のゲームに悪影響を与える
   - **軽減策**: ゲーム終了時とゲーム開始時のダブルチェックで確実に削除。削除対象のエンティティをタグ付けして識別しやすくする

## Notes *(optional)*

### 設計上の考慮事項

- この仕様書はゲームの基本フレームワークを定義しており、具体的な数値（食べ物のポイント価値、ショップ価格、ボスのHP、襲撃モンスターの種類など）は、バランステストを基に段階的に決定することを推奨
- 将来的な拡張性を考慮し、設定ファイルで以下の項目を変更可能にすることを推奨：
  - ゲーム制限時間
  - ボス出現に必要なイベントクリア回数
  - 宝箱の種類別出現率
  - トラップチェストの装備出現確率
  - Murdererフラグの持続時間
  - マップサイズ
  - 各種ポイント倍率

### 将来的な改善案

- プレイヤーコミュニティの形成を促進するため、シーズン制やランキングシステムの導入を検討可能
- プレイヤーからのフィードバック収集機能（アンケート、バグレポートなど）の組み込みを推奨
- 観戦モードの追加により、死亡中やゲーム不参加のプレイヤーも楽しめる
- カスタムマップやゲームモードのバリエーション追加（例：夜間限定、特定アイテム禁止など）
- 実績システムの追加（特定条件達成で称号やバッジ獲得）

### 技術的な注意点

- **MythicMobsのバージョン互換性を事前に確認**
- **MythicMobs設定**:
  - 襲撃イベントのモンスターとボスはMythicMobsの設定ファイルで定義
  - イベントNPCもMythicMobsで実装（村人の見た目、無敵設定、メッセージスキル）
  - `onInteract`トリガーでクリック検知
  - `onPlayerNear`トリガーで近接プレイヤー検知
  - `message`スキルでメッセージ表示（ヘルプ、感謝、罵倒）
  - ドロップアイテムもMythicMobsで設定可能
  - MythicMobsのモンスターには`PreventSunburn: true`設定を使用して日光ダメージを無効化（ヘルメット装備は不要）
- **ボスバーAPI**: Paper APIまたはSpigot APIの使用方法を確認
- **GUIメニュー**: Inventory APIを使用してショップGUIを実装
- **プレイヤー名表示**: スコアボードまたはパケット操作で頭上に名前を表示
- **ワールド境界**: WorldBorder APIで実装
- **MythicMobsスポーン制御**: プラグインからMythicMobs APIを使用してモンスターとNPCを動的にスポーン
- **ゲーム情報表示**:
  - **スコアボード**: Bukkit Scoreboard APIを使用して画面右側に情報を表示
  - **タイトルメッセージ**: `player.sendTitle()`メソッドで画面中央に大きなメッセージを表示
  - **アクションバー**: `player.sendActionBar()`メソッドでインベントリ上にメッセージを表示
  - **タブリスト**: `player.setPlayerListName()`でプレイヤー名の色を設定、Team APIでチーム別色分け
  - **コマンド**: Bukkitコマンドシステムで`/stats`コマンドを実装
- **ゲーム初期化と後始末**:
  - **エンティティ削除**: プラグインが生成した全てのエンティティ（宝箱、NPC、ボス、モンスター）にタグ付けして識別し、確実に削除
  - **ダブルチェック**: ゲーム終了時とゲーム開始時の両方で削除処理を実行
  - **テレポート処理**: 全プレイヤーを一度に処理せず、サーバー負荷を考慮して適切に分散（全てを非同期で処理するとサーバークラッシュの危険がある）
  - **構造物選択**: 設定ファイルで固定/ランダムを選択可能。ランダムの場合は地上の構造物を自動検索
  - **ワールド管理**: 同じワールドを使い続け、ワールドの再生成は管理者に任せる
